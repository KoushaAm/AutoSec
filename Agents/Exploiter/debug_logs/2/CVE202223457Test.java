package org.owasp.esapi.reference;

import static org.junit.Assert.assertThrows;

import java.io.File;

import org.junit.Test;
import org.owasp.esapi.ESAPI;
import org.owasp.esapi.ValidationErrorList;
import org.owasp.esapi.Validator;
import org.owasp.esapi.errors.ValidationException;

/**
 * This test fails if getValidDirectoryPath incorrectly accepts an absolute path
 * that is outside the specified parent directory (CWE-22 / CVE-2022-23457).
 */
public class CVE202223457Test {

    @Test
    public void testGetValidDirectoryPathRejectsOutsideParent() throws Exception {
        Validator instance = ESAPI.validator();

        // parent: use ESAPI's resource directory so it's inside the project
        File parent = ESAPI.securityConfiguration().getResourceFile("ESAPI.properties").getParentFile().getCanonicalFile();

        // create an external directory outside the parent (under /tmp)
        File outside = new File("/tmp/esapi_cve_test_outside_dir");
        outside.mkdirs();
        outside.getCanonicalPath();

        // When the validator is correct, validating an absolute path outside the parent
        // should throw ValidationException. If the vulnerability exists, the call may
        // incorrectly succeed and the test will fail.
        assertThrows(ValidationException.class, () -> {
            ValidationErrorList errors = new ValidationErrorList();
            // use the overload that reports errors as well
            instance.getValidDirectoryPath("cve-test", outside.getCanonicalPath(), parent, false, errors);
            // If implementation returns normally (no exception), force a failure by throwing
            // a ValidationException here so the assertThrows block will fail if no exception occurred.
            // (We don't throw here; assertThrows will fail because no exception was thrown.)
        });
    }
}
