package org.owasp.esapi.reference;

import static org.junit.Assert.fail;

import java.io.File;

import org.junit.Test;
import org.owasp.esapi.ESAPI;
import org.owasp.esapi.Validator;
import org.owasp.esapi.errors.ValidationException;

public class PathTraversalTest {

    @Test
    public void testGetValidDirectoryPathRejectsSiblingDirectories() throws Exception {
        // Prepare two directories under /tmp: one parent and one sibling whose name starts with parent's name
        File parent = new File("/tmp/esapi_parent_test");
        File trick = new File("/tmp/esapi_parent_test_malicious");
        try {
            parent.mkdirs();
            trick.mkdirs();

            Validator v = ESAPI.validator();

            try {
                v.getValidDirectoryPath("pt", trick.getAbsolutePath(), parent, false);
                // If we reach here, the validator accepted the trick path — this indicates a vulnerability.
                fail("Expected ValidationException due to directory not being a child of parent");
            } catch (ValidationException e) {
                // Expected — test passes
            }
        } finally {
            // best-effort cleanup
            try { trick.delete(); } catch (Exception ignored) {}
            try { parent.delete(); } catch (Exception ignored) {}
        }
    }
}
