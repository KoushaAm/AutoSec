package org.owasp.esapi.vuln;

import static org.junit.Assert.assertFalse;
import static org.junit.Assert.fail;

import java.io.File;

import org.junit.Test;
import org.owasp.esapi.ESAPI;
import org.owasp.esapi.Validator;
import org.owasp.esapi.errors.IntrusionException;
import org.owasp.esapi.errors.ValidationException;

public class PathTraversalCheckTest {

    @Test
    public void testDirectoryMustBeChildOfParent() throws Exception {
        Validator v = ESAPI.validator();

        // Create parent and an outside directory with a similar prefix
        File parent = new File("/tmp/safe");
        File outside = new File("/tmp/safe_evil");

        // Ensure directories exist so the validator's existence checks pass
        parent.mkdirs();
        outside.mkdirs();

        // Sanity: these are distinct and outside is NOT a child of parent
        // Use a robust check that constructs what the child's path would be if it were under parent
        assertFalse(new File(parent, outside.getName()).getCanonicalPath().equals(outside.getCanonicalPath()));

        try {
            // If the validator is vulnerable it will accept outside (which is NOT a child)
            v.getValidDirectoryPath("test", outside.getPath(), parent, false);
            // If we get here, the validator accepted an outside directory -> FAIL the test
            fail("Validator incorrectly accepted a directory outside the specified parent (possible path traversal / prefix check bypass)");
        } catch (ValidationException | IntrusionException expected) {
            // Expected behavior: validation fails. Test passes.
        }
    }
}
