package org.owasp.esapi.reference;

import org.junit.Test;
import org.owasp.esapi.ESAPI;
import org.owasp.esapi.errors.ValidationException;

import java.io.File;

import static org.junit.Assert.fail;

public class CWE22_DefaultValidatorPathTraversalTest {

    @Test
    public void testDirectoryPathPrefixTraversal() throws Exception {
        // Create two directories such that one directory's path starts with the other's path
        File parent = new File("/tmp/esapi_parent");
        File outsideButPrefix = new File("/tmp/esapi_parent_malicious");

        try {
            parent.mkdirs();
            outsideButPrefix.mkdirs();

            // Ensure they exist and are directories
            if (!parent.exists() || !parent.isDirectory() || !outsideButPrefix.exists() || !outsideButPrefix.isDirectory()) {
                throw new RuntimeException("Failed to create test directories");
            }

            try {
                ESAPI.validator().getValidDirectoryPath("cwe22", outsideButPrefix.getAbsolutePath(), parent, false);
                // If we reach here, no ValidationException was thrown -> vulnerable -> fail the test
                fail("Expected ValidationException for directory outside the parent (possible path traversal)");
            } catch (ValidationException expected) {
                // Correct behavior: library rejected the outside directory -> test passes
            }
        } finally {
            // Cleanup
            try { new File("/tmp/esapi_parent_malicious").delete(); } catch (Throwable ignored) {}
            try { new File("/tmp/esapi_parent").delete(); } catch (Throwable ignored) {}
        }
    }
}
