from vuln_agent.core.engine import AgentEngine
from vuln_agent.helpers import *

# this is git url extractor helper. A halper for `_init_git_snapshot_as_repo`
def _extract_repo_url(dataset: str, project: str, workdir: Path) -> str:
    candidates = []

    # cwe-bench-java: try existing processed commit info
    if dataset == "cwe-bench-java":
        commit_info = (Path(workdir) / f"../../../data/processed/{project}/.commit_info.json").resolve()
        if commit_info.exists():
            info = json.loads(commit_info.read_text())
            for k in ("repo", "repo_url", "repository", "git_url", "url", "clone_url"):
                if k in info and isinstance(info[k], str) and info[k].strip():
                    candidates.append(info[k].strip())

        advisory = Path('data') / args.dataset / 'advisory' / f"{project}.json"

        if advisory.exists():
            adv = json.loads(advisory.read_text())
            for k in ("repo", "repo_url", "repository", "url"):
                v = adv.get(k)
                if isinstance(v, str) and v.strip():
                    candidates.append(v.strip())
            refs = adv.get("references")
            if isinstance(refs, list):
                # 1) prefer the repo root (type == PACKAGE)
                for r in refs:
                    if isinstance(r, dict) and r.get("type") == "PACKAGE":
                        u = r.get("url", "")
                        if isinstance(u, str) and u.strip():
                            candidates.append(u.strip())

                # 2) git-host URLs, but skip advisory pages/blobs/commits
                for r in refs:
                    if isinstance(r, dict):
                        u = r.get("url", "")
                        if not isinstance(u, str):
                            continue
                        u = u.strip()
                        if ("github.com" in u or "gitlab.com" in u):
                            if any(x in u for x in ("/security/advisories/", "/commit/", "/blob/")):
                                continue
                            candidates.append(u)

    # primevul: try processed_info.json
    if dataset == "primevul":
        info_path = (Path(workdir) / "../../../processed_info.json").resolve()
        if info_path.exists():
            info = json.loads(info_path.read_text())
            proj = info.get(project, {}) if isinstance(info, dict) else {}
            for k in ("repo", "repo_url", "repository", "git_url", "url", "clone_url"):
                v = proj.get(k)
                if isinstance(v, str) and v.strip():
                    candidates.append(v.strip())

    for u in candidates:
        if u.endswith(".git"):
            return u
    if candidates:
        return candidates[0]

    raise ValueError(
        "Could not determine repo URL from existing metadata. "
        "Add repo_url (or repo) to .commit_info.json / processed_info.json."
    )


def _init_git_snapshot_as_repo(dataset: str, project: str, project_workdir: Path, workdir: Path, logger: Logger) -> None:
    # already a repo? do nothing
    if (project_workdir / ".git").exists():
        return

    repo_url = _extract_repo_url(dataset, project, workdir)
    logger.log_status(f"Initializing git repo in snapshot at {project_workdir} (remote: {repo_url})")

    run(f"git -C {project_workdir} init", timeout=120, logger=logger)
    try:
        run(f"git -C {project_workdir} remote add origin {repo_url}", timeout=120, logger=logger)
    except Exception:
        run(f"git -C {project_workdir} remote set-url origin {repo_url}", timeout=120, logger=logger)

    run(f"git -C {project_workdir} fetch --all --tags --prune", timeout=600, logger=logger)
    try:
        run(f"git -C {project_workdir} fetch", timeout=600, logger=logger)
    except Exception:
        pass

    # Snapshot files are untracked; checkout would fail with "untracked ... would be overwritten"
    # So commit the snapshot locally (not pushed anywhere).
    try:
        run(f"git -C {project_workdir} rev-parse --verify HEAD", timeout=60, logger=logger)
    except Exception:
        run(f"git -C {project_workdir} config user.email autosec@local", timeout=60, logger=logger)
        run(f"git -C {project_workdir} config user.name AutoSec", timeout=60, logger=logger)
        run(f"git -C {project_workdir} add -A", timeout=300, logger=logger)
        run(f"git -C {project_workdir} commit -m 'snapshot'", timeout=300, logger=logger)


if __name__ == '__main__':

    parser = argparse.ArgumentParser(description='Vuln Agent - generating vulnerability test cases')
    parser.add_argument('--dataset',    type=str,     default='cwe-bench-java', help='Dataset to use')
    parser.add_argument('--project',    type=str,     required=True,            help='Project to use')
    parser.add_argument('--model',      type=str,     default='gpt5',       help='Model to use')
    parser.add_argument('--budget',     type=float,   default=5.0,              help='Budget in dollars')
    parser.add_argument('--timeout',    type=int,     default=2400,             help='Time budget in seconds')
    parser.add_argument('--use_patch',  action='store_true',                    help='Use patch file if available')
    parser.add_argument('--no_flow',   action='store_true',                    help='Disable flow analysis')
    parser.add_argument('--no_branch', action='store_true',                    help='Disable branch analysis')
    parser.add_argument('--verbose',    action='store_true',                    help='Enable verbose output')
    args = parser.parse_args()

    workdir_suffix = "_no_flow" if args.no_flow else ""
    workdir_suffix += "_no_branch" if args.no_branch else ""

    if args.dataset == 'cwe-bench-java' or args.dataset == 'primevul':
        project_dir = Path('data') / args.dataset / 'project-sources' / args.project
        workdir = Path('data') / args.dataset / f'workdir{workdir_suffix}'
        if not workdir.exists():
            workdir.mkdir(parents=True, exist_ok=True)
        if args.dataset == 'cwe-bench-java':
            java_env_dir = workdir / 'java-env'
            if not java_env_dir.exists():
                shutil.copytree('data/cwe-bench-java/java-env', java_env_dir)



            resources_dir = workdir / 'resources'
            if not resources_dir.exists():
                shutil.copytree('data/cwe-bench-java/resources', resources_dir)
        project_workdir = workdir / 'project-sources' / args.project



        if project_workdir.exists():
            print(f"Error: project workdir {project_workdir} already exists. Please remove it first.")
            exit(1)
        if not project_dir.exists():
            raise ValueError(f"Project {args.project} does not exist in {project_dir}")
        shutil.copytree(project_dir, project_workdir)
        project_workdir = Path(project_workdir).absolute()
        if not project_workdir.exists():
            raise ValueError(f"{project_workdir} does not exist after copying from {project_dir}")
    else:
        raise ValueError(f"Unknown dataset: {args.dataset}")

    timestr = datetime.datetime.now().strftime('%Y%m%d_%H%M%S')
    log_folder = Path("logs") / f"{args.project}_{timestr}"
    if not log_folder.exists():
        log_folder.mkdir(parents=True, exist_ok=True)

    logger = Logger(log_folder.absolute(), args, verbose=args.verbose)

    # initialize the porject as git repo:
    try:
        _init_git_snapshot_as_repo(args.dataset, args.project, project_workdir, workdir, logger)
    except Exception as e:
        print(f"Failed to initialize snapshot git repo: {e}")
        raise

    engine = AgentEngine(dataset=args.dataset,
                        project=args.project,
                        model=args.model,
                        workdir=project_workdir,
                        logger=logger,
                        budget=args.budget,
                        timeout=args.timeout,
                        use_patch=args.use_patch,
                        no_flow=args.no_flow,
                        no_branch=args.no_branch)

    engine.run()

    engine.print_results()