
package exploiter.sandbox;

import org.junit.jupiter.api.AfterEach;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import java.io.File;
import java.io.FileWriter;
import java.io.IOException;
import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;

import static org.junit.jupiter.api.Assertions.*;

public class MainTest {

    private String[] payloads = {
            "; touch /tmp/injected",
            "& touch /tmp/injected",
            "| touch /tmp/injected",
            "`touch /tmp/injected`",
            "; rm -rf /tmp/testfile",
            "; echo \"injected\" > /tmp/testfile"
    };

    @BeforeEach
    void setUp() {
        // Create a test file
        File file = new File("target/testfile");
        try {
            file.createNewFile();
        } catch (IOException e) {
            fail("Failed to create test file");
        }
    }

    @AfterEach
    void tearDown() {
        // Delete the test file
        File file = new File("target/testfile");
        file.delete();
        // Delete the injected file
        File injectedFile = new File("/tmp/injected");
        if (injectedFile.exists()) {
            injectedFile.delete();
        }
    }

    @Test
    void testCommandInjection() {
        try (FileWriter writer = new FileWriter("report.txt")) {
            for (String payload : payloads) {
                Process p = Runtime.getRuntime().exec(new String[]{"/bin/sh", "-c", "java Main " + payload});
                int rc = p.waitFor();
                writer.write("Payload: " + payload + "\n");
                writer.write("Exit code: " + rc + "\n");
                if (new File("/tmp/injected").exists() || new File("/tmp/testfile").exists()) {
                    writer.write("Exploitation status: YES\n\n");
                } else {
                    writer.write("Exploitation status: NO\n\n");
                }
            }
        } catch (IOException | InterruptedException e) {
            fail("Failed to write report");
        }
    }
}
