import os
from dotenv import load_dotenv
from openai import OpenAI
from utils.models import *
import json
import re
from E2E.prompts import MOCKITO_FIX_GUIDANCE


PROMPT_PATH = "E2E/assets/tester_prompt.txt"
TEST_PATH = "E2E/assets/generated_test.java"
RAW_OUTPUT_PATH = "E2E/assets/tester_raw_output.txt"

def main(): 
    with open(PROMPT_PATH, "r", encoding="utf-8") as f:
        prompt = f.read()
    
        prompt = prompt + "\n\n" + MOCKITO_FIX_GUIDANCE
    
    client, model = initialize()
    output = generate(client, model, prompt)

    with open(RAW_OUTPUT_PATH, "w", encoding="utf-8") as fh:
        fh.write(output)


    # Clean up code-fence wrappers and whitespace
    cleaned = output.strip()
    # remove a leading ``` or ```java
    cleaned = re.sub(r"^```(?:java)?\s*", "", cleaned, flags=re.MULTILINE)
    # remove a trailing ```
    cleaned = re.sub(r"\s*```$", "", cleaned, flags=re.MULTILINE)
    cleaned = cleaned.strip()

    with open(TEST_PATH, "w", encoding="utf-8") as f:
        f.write(cleaned)
    
    print(f"[+] Written generated test to: {TEST_PATH}")


if __name__ == "__main__":
    main()
