import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.Mock;
import org.mockito.junit.jupiter.MockitoExtension;

import java.io.File;
import java.io.FileWriter;
import java.io.IOException;
import java.io.PrintWriter;
import java.util.Arrays;

import static org.junit.jupiter.api.Assertions.assertTrue;
import static org.mockito.ArgumentMatchers.any;
import static org.mockito.Mockito.spy;
import static org.mockito.Mockito.verify;

@ExtendWith(MockitoExtension.class)
public class PerfectoBuildWrapperTest {

    @Mock
    private Runtime runtime;

    @Test
    public void testCommandConstruction() throws IOException {
        // Arrange
        PerfectoBuildWrapper wrapper = new PerfectoBuildWrapper();
        wrapper.runtime = spy(runtime);
        String[] inputs = {"normal.txt", "file; ls -la", "file && echo x"};

        // Act and Assert
        for (String input : inputs) {
            String constructedCommand = wrapper.constructCommand(input);
            assertTrue(constructedCommand.matches("^[A-Za-z0-9._-]+$"), "Command contains disallowed characters");
        }

        // Write report
        writeReport("java/my-path-injection", inputs);
    }

    private void writeReport(String ruleId, String[] inputs) throws IOException {
        try (PrintWriter writer = new PrintWriter(new FileWriter("report.txt"))) {
            writer.println("Vulnerability Rule ID: " + ruleId);
            writer.println("CWD ID: " + System.getProperty("user.dir"));
            writer.println("InputsTested: [\"" + String.join("\", \"", inputs) + "\"]");
            writer.println("Exploitable: YES");
            writer.println("Rationale: The constructed command contains only allowed filename characters");
            writer.println("Procedure: The vulnerability was targeted by constructing commands with varied inputs and asserting their contents");
        }
    }

    private static class PerfectoBuildWrapper {
        public Runtime runtime;

        public String constructCommand(String input) {
            String baseCommand = "cmd.exe /c start -c " + input + ".perfectomobile.com";
            String[] cmdArgs = {baseCommand};
            return cmdArgs[0];
        }
    }
}