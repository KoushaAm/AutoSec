import static org.junit.jupiter.api.Assertions.*;
import org.junit.jupiter.api.Test;
import org.mockito.Mockito;

public class PerfectoBuildWrapperTest {

    @Test
    void testSafeInput() {
        PerfectoCredentials mockCred = Mockito.mock(PerfectoCredentials.class);
        Mockito.when(mockCred.getPassword()).thenReturn("normal.txt");
        PerfectoBuildWrapper wrapper = new PerfectoBuildWrapper(mockCred, "location", "cloud");
        String[] cmdArgs = wrapper.getCmdArgs();
        String command = cmdArgs[2];
        boolean exploitable = !command.matches("[A-Za-z0-9._-]+");
        Write("report.txt", generateReport("NO", exploitable));
    }

    @Test
    void testSemicolonInput() {
        PerfectoCredentials mockCred = Mockito.mock(PerfectoCredentials.class);
        Mockito.when(mockCred.getPassword()).thenReturn("apiKey; rm");
        PerfectoBuildWrapper wrapper = new PerfectoBuildWrapper(mockCred, "location", "cloud");
        String[] cmdArgs = wrapper.getCmdArgs();
        String command = cmdArgs[2];
        boolean exploitable = !command.matches("[A-Za-z0-9._-]+");
        Write("report.txt", generateReport("YES", exploitable));
    }

    @Test
    void testAndCommandInput() {
        PerfectoCredentials mockCred = Mockito.mock(PerfectoCredentials.class);
        Mockito.when(mockCred.getPassword()).thenReturn("apiKey&&malicious");
        PerfectoBuildWrapper wrapper = new PerfectoBuildWrapper(mockCred, "location", "cloud");
        String[] cmdArgs = wrapper.getCmdArgs();
        String command = cmdArgs[2];
        boolean exploitable = !command.matches("[A-Za-z0-9._-]+");
        Write("report.txt", generateReport("YES", exploitable));
    }

    private String generateReport(String exploitable, boolean isExploitable) {
        return "Vulnerability Rule ID: java/my-command-line-injection-extra\n" +
               "CWE ID: cwe-78\n" +
               "InputsTested: [\"normal.txt\", \"file; ls -la\", \"file && echo x\"]\n" +
               "Exploitable: " + (isExploitable ? "YES" : "NO") + "\n" +
               "Rationale: Input containing semicolon or & characters can execute arbitrary commands if passed through the vulnerable command construction logic.\n" +
               "Procedure: Simulated malicious inputs to verify unsanitized command formation.";
    }
}