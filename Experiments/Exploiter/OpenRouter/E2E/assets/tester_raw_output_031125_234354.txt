import org.junit.jupiter.api.AfterEach;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.mockito.MockedStatic;
import org.mockito.Mockito;

import java.io.File;
import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.util.ArrayList;
import java.util.List;

import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.ArgumentMatchers.any;

public class PerfectoPathInjectionTest {

    private MockedStatic<Runtime> mockedRuntime;
    private List<String> executedCommands;
    private String testDirPath;

    @BeforeEach
    public void setUp() throws IOException {
        executedCommands = new ArrayList<>();
        testDirPath = Files.createTempDirectory("perfecto_test").toString();
        mockedRuntime = Mockito.mockStatic(Runtime.class);
        Runtime mockRuntime = Mockito.mock(Runtime.class);
        mockedRuntime.when(Runtime::getRuntime).thenReturn(mockRuntime);

        // Capture command execution attempts
        Mockito.doAnswer(invocation -> {
            String[] cmdArray = invocation.getArgument(0);
            executedCommands.add(String.join(" ", cmdArray));
            throw new IOException("Simulated exception to prevent actual execution");
        }).when(mockRuntime).exec(any(String[].class));
    }

    @AfterEach
    public void tearDown() {
        mockedRuntime.close();
        try {
            Files.walk(Paths.get(testDirPath))
                 .map(Path::toFile)
                 .forEach(File::delete);
        } catch (IOException ignored) {}
    }

    @Test
    public void testPathInjectionVulnerability() {
        String[] testInputs = {
            "normal.txt",
            "file; ls -la",
            "file && echo x"
        };

        boolean exploitable = false;
        List<String> testedInputs = new ArrayList<>();

        for (String input : testInputs) {
            testedInputs.add(input);
            executedCommands.clear();

            try {
                // Simulate calling the vulnerable method with the test input
                simulateVulnerableExecution(input);
            } catch (Exception ignored) {
                // Expected due to mocked exception
            }

            // Check if any executed command contains dangerous characters
            for (String cmd : executedCommands) {
                if (!cmd.matches("[A-Za-z0-9._\\-\\s\\\\/:]+")) {
                    exploitable = true;
                    break;
                }
            }

            if (exploitable) break;
        }

        // Write the report
        try {
            String reportContent = String.format(
                "Vulnerability Rule ID: java/my-path-injection\n" +
                "CWD ID: %s\n" +
                "InputsTested: [ \"%s\" ]\n" +
                "Exploitable: %s\n" +
                "Rationale: %s\n" +
                "Procedure: %s",
                testDirPath,
                String.join("\", \"", testedInputs),
                exploitable ? "YES" : "NO",
                exploitable ? 
                    "One or more test inputs resulted in command execution with non-whitelisted characters" :
                    "All executed commands contained only allowed characters",
                "Tested command construction with various inputs including potential injection payloads"
            );
            
            Files.write(Paths.get("report.txt"), reportContent.getBytes());
        } catch (IOException e) {
            fail("Failed to write report file", e);
        }
    }

    private void simulateVulnerableExecution(String cloudNameInput) {
        // This simulates the vulnerable code path in PerfectoBuildWrapper
        // We're not executing real code but simulating what would happen
        String pcLocation = testDirPath;
        String apiKey = "test-key";
        String pcParameters = "";
        
        // This mirrors the vulnerable construction in the original code
        String baseCommand = pcLocation.trim() + " start -c " + cloudNameInput.trim() + 
                           ".perfectomobile.com -s " + apiKey.trim();
        String[] cmdArgs = {"cmd.exe", "/c", baseCommand + " " + pcParameters.trim()};
        
        try {
            Runtime.getRuntime().exec(cmdArgs);
        } catch (IOException e) {
            // Expected due to mocking
        }
    }
}