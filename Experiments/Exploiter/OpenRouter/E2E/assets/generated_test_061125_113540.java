import org.junit.jupiter.api.AfterEach;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.io.TempDir;
import java.io.File;
import java.io.FileWriter;
import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.util.List;

import static org.junit.jupiter.api.Assertions.*;

public class LibraryAdderTest {

    private Path tempDir;

    @BeforeEach
    void setup(@TempDir Path tempDir) {
        this.tempDir = tempDir;
    }

    @AfterEach
    void cleanup() throws IOException {
        Files.walk(tempDir).forEach(file -> {
            try {
                Files.deleteIfExists(file);
            } catch (IOException e) {
                // Ignore
            }
        });
    }

    @Test
    void testLibraryAdder() throws IOException {
        // Create test inputs
        String[] inputs = {"normalLib", "../evil", "safe; rm -rf /"};

        // Create a report file
        Path reportFile = tempDir.resolve("report.txt");
        try (FileWriter writer = new FileWriter(reportFile.toFile())) {
            writer.write("Vulnerability Rule ID: CVE-2022-25174\n");
            writer.write("CWE ID: CWE-22\n");
            writer.write("InputsTested: [ \"" + String.join("\", \"", inputs) + "\" ]\n");

            boolean exploitable = false;
            String rationale = "";
            String procedure = "";

            for (String input : inputs) {
                // Create a new LibraryAdder instance
                org.jenkinsci.plugins.workflow.libs.global.LibraryAdder libraryAdder = new org.jenkinsci.plugins.workflow.libs.global.LibraryAdder();

                // Create a temporary directory for the library
                Path libraryDir = tempDir.resolve(input);

                // Try to add the library
                try {
                    libraryAdder.addLibrary(libraryDir.toString(), tempDir.toString());
                } catch (Exception e) {
                    // Ignore
                }

                // Check if the library was created outside the base directory
                if (libraryDir.getParent().equals(tempDir)) {
                    // Check if the library directory exists
                    if (Files.exists(libraryDir)) {
                        exploitable = true;
                        rationale = "The library directory was created outside the base directory.";
                        procedure = "The LibraryAdder.addLibrary method was called with a malicious input.";
                    }
                }
            }

            writer.write("Exploitable: " + (exploitable ? "YES" : "NO") + "\n");
            writer.write("Rationale: " + rationale + "\n");
            writer.write("Procedure: " + procedure + "\n");
        }
    }
}