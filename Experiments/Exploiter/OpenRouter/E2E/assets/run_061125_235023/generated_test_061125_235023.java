package io.plugins.perfecto.test;

import org.junit.jupiter.api.Test;

import java.lang.reflect.Field;
import java.lang.reflect.Method;
import java.util.ArrayList;
import java.util.List;
import java.util.regex.Pattern;

public class PerfectoCommandInjectionTest {

    @Test
    public void testCommandInjection() throws Exception {
        String[] testInputs = {
            "safe_input123",
            "malicious; rm -rf /",
            "special_chars!@#"
        };

        List<String> report = new ArrayList<>();

        for (String input : testInputs) {
            Object credentials = createCredentials(input);
            String apiKey = (String) getApiKey(credentials);
            String[] cmdArgs = executeBuildCommand(apiKey, "pcParameters");

            boolean exploitable = false;
            for (String arg : cmdArgs) {
                if (!Pattern.matches("[A-Za-z0-9._-]*", arg)) {
                    exploitable = true;
                    break;
                }
            }

            String reportLine = String.format("Vulnerability Rule ID: java/my-command-line-injection-extra\n" +
                    "CWE ID: 787\n" +
                    "InputsTested: [\"%s\"]\n" +
                    "Exploitable: %s\n" +
                    "Rationale: Command string contains injected characters when testing with '%s'.\n" +
                    "Procedure: Injected payload '%s' bypassed sanitization checks.", 
                    input, exploitable ? "YES" : "NO", input, input);

            report.add(reportLine);
        }

        writeReport(report);
    }

    private Object createCredentials(String input) throws Exception {
        Class<?> perfectoCredentials = Class.forName("io.plugins.perfecto.credentials.PerfectoCredentials");
        Field inputField = perfectoCredentials.getDeclaredField("input");
        inputField.setAccessible(true);
        Object credentials = perfectoCredentials.getDeclaredConstructor().newInstance();
        inputField.set(credentials, input);
        return credentials;
    }

    private String getApiKey(Object credentials) throws Exception {
        Class<?> credentialsClass = credentials.getClass();
        Field apiKeyField = credentialsClass.getDeclaredField("apiKey");
        apiKeyField.setAccessible(true);
        return (String) apiKeyField.get(credentials);
    }

    private String[] executeBuildCommand(String apiKey, String pcParameters) throws Exception {
        Class<?> perfectoBuildWrapper = Class.forName("io.plugins.perfecto.PerfectoBuildWrapper");
        Method buildCommandMethod = perfectoBuildWrapper.getDeclaredMethod("buildCommand", String.class, String.class);
        buildCommandMethod.setAccessible(true);
        Object wrapper = perfectoBuildWrapper.getDeclaredConstructor().newInstance();
        buildCommandMethod.invoke(wrapper, apiKey, pcParameters);

        Field cmdArgsField = wrapper.getClass().getDeclaredField("cmdArgs");
        cmdArgsField.setAccessible(true);
        return (String[]) cmdArgsField.get(wrapper);
    }

    private void writeReport(List<String> reportLines) {
        String content = reportLines.stream()
                .reduce("", (a, b) -> a + "\n" + b)
                .trim();
        Write("report.txt", content);
    }

    // Stub for required Write tool
    private void Write(String path, String content) {
        // Implementation would use the provided Write tool
    }
}