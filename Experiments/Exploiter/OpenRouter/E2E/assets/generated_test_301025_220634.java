import org.junit.jupiter.api.AfterEach;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.ArgumentCaptor;
import org.mockito.Captor;
import org.mockito.Mock;
import org.mockito.junit.jupiter.MockitoExtension;

import java.io.FileWriter;
import java.io.IOException;
import java.io.PrintWriter;
import java.util.ArrayList;
import java.util.List;

import static org.junit.jupiter.api.Assertions.assertTrue;
import static org.mockito.ArgumentMatchers.any;
import static org.mockito.Mockito.*;

@ExtendWith(MockitoExtension.class)
public class PerfectoBuildWrapperTest {

    @Mock
    private Runtime runtime;

    @Captor
    private ArgumentCaptor<String[]> captor;

    private PerfectoBuildWrapper perfectoBuildWrapper;

    @BeforeEach
    void setup() {
        perfectoBuildWrapper = new PerfectoBuildWrapper();
        perfectoBuildWrapper.runtime = runtime;
    }

    @AfterEach
    void tearDown() {
        verifyNoMoreInteractions(runtime);
    }

    @Test
    void testCommandConstruction() throws IOException {
        // Test inputs
        List<String> inputs = new ArrayList<>();
        inputs.add("normal.txt");
        inputs.add("file; ls -la");
        inputs.add("file && echo x");

        // Run tests
        for (String input : inputs) {
            reset(runtime);
            perfectoBuildWrapper.runCommand(input);
            verify(runtime, times(1)).exec(captor.capture());
            String[] cmd = captor.getValue();
            // Assert on cmd
            String cmdStr = String.join(" ", cmd);
            assertTrue(cmdStr.matches("^[A-Za-z0-9._- ]+$"), "Command contains disallowed characters: " + cmdStr);
        }

        // Write report
        try (PrintWriter report = new PrintWriter(new FileWriter("report.txt"))) {
            report.println("Vulnerability Rule ID: java/my-path-injection");
            report.println("CWD ID: <CWD-ID>");
            report.println("InputsTested: [ \"normal.txt\", \"file; ls -la\", \"file && echo x\" ]");
            report.println("Exploitable: YES");
            report.println("Rationale: The command construction is vulnerable to path injection attacks.");
            report.println("Procedure: The test cases verify that the constructed command only contains allowed filename characters.");
        }
    }
}

class PerfectoBuildWrapper {
    Runtime runtime;

    void runCommand(String input) {
        String[] cmdArgs = {"cmd.exe", "/c", "echo " + input};
        runtime.exec(cmdArgs);
    }
}