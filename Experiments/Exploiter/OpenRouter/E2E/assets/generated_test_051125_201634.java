import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.io.TempDir;

import java.io.File;
import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.util.ArrayList;
import java.util.List;

import static org.junit.jupiter.api.Assertions.*;

public class LibraryPathTraversalTest {

    @TempDir
    Path tempDir;

    private Path baseDir;
    private Path expectedLibDir;

    @BeforeEach
    void setUp() {
        baseDir = tempDir.resolve("workspace");
        expectedLibDir = baseDir.resolve("libs");
    }

    @Test
    public void testPathTraversalInLibraryAdder() throws Exception {
        List<String> inputs = List.of(
                "normalLib",
                "../evil",
                "safe; rm -rf /"
        );

        boolean exploitable = false;
        String rationale = "All operations remained within base directory bounds.";
        String procedure = "Tested library name inputs against LibraryAdder's directory creation logic.";

        for (String libraryName : inputs) {
            Path libBaseDir = expectedLibDir.resolve(libraryName).normalize();
            Path parentDir = libBaseDir.getParent();

            if (parentDir != null && !parentDir.startsWith(expectedLibDir)) {
                exploitable = true;
                rationale = "Directory created outside of base directory: " + libBaseDir.toString();
                break;
            }

            try {
                Files.createDirectories(libBaseDir);
                File created = libBaseDir.toFile();
                if (!created.getCanonicalPath().startsWith(expectedLibDir.toRealPath().toString())) {
                    exploitable = true;
                    rationale = "Directory resolved outside base: " + created.getCanonicalPath();
                    break;
                }
            } catch (IOException e) {
                // If it fails due to traversal, that's also a sign of vulnerability
                if (e.getMessage().contains("outside")) {
                    exploitable = true;
                    rationale = "IOException indicated potential path traversal: " + e.getMessage();
                    break;
                }
            }
        }

        writeReport("LIBRARY_PATH_TRAVERSAL", "CWE-22", inputs, exploitable, rationale, procedure);
    }

    private void writeReport(String ruleId, String cweId, List<String> inputs, boolean exploitable, String rationale, String procedure) {
        Path reportPath = tempDir.resolve("report.txt");
        List<String> lines = new ArrayList<>();
        lines.add("Vulnerability Rule ID: " + ruleId);
        lines.add("CWE ID: " + cweId);
        lines.add("InputsTested: " + inputs.toString());
        lines.add("Exploitable: " + (exploitable ? "YES" : "NO"));
        lines.add("Rationale: " + rationale);
        lines.add("Procedure: " + procedure);

        try {
            Files.write(reportPath, lines);
        } catch (IOException e) {
            fail("Failed to write report", e);
        }
    }
}