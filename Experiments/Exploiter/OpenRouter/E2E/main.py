from E2E.control_flow import * 
from E2E.data_flow import *
from E2E.prompt_gen import *
from utils import *
import os
import json
from utils.models import initialize
import argparse
import time


SARIF_SUMMARY_PATH = "E2E/assets/data_preprocessed_perfecto_3.json"
PROJECT_ROOT = "../jenkinsci__perfecto-plugin_CVE-2020-2261_1.17"
RAW_OUTPUT_PATH = f"E2E/assets/tester_raw_output_{time_postfix}.txt"

time_postfix = time.strftime("%d%m%y_%H%M%S")   


def generate_workspace(): 
    location = f"E2E/assets/run_{time_postfix}/"
    os.makedirs(location, exist_ok=True)
    return location

def pipeline():
    workspace = generate_workspace()

    print("[*] Starting E2E Tester Prompt Generation Pipeline")

    load_dotenv()
    client, model = initialize()

    sarif_summary = open(SARIF_SUMMARY_PATH).read()

    print("[*] Running Data Flow Analysis...")
    # 1: Data Flow Analysis
    flow_result = request_flow(
        client, model, BASE_PROMPT, PROJECT_ROOT, sarif_summary
    )
    flow_json = flow_result["flow"]

    with open(f"{workspace}data_flow_{time_postfix}.json", "w") as f:
        json.dump(flow_result, f, indent=2)
        
    print("[*] Running Control Flow Analysis...")
    # 2: Control Flow Analysis
    control_result = request_branch_reasoning(
        client, model, BASE_PROMPT, PROJECT_ROOT, flow_json, sarif_summary
    )

    with open(f"{workspace}control_flow_{time_postfix}.json", "w") as f:
        json.dump(control_result, f, indent=2)

    print("[*] Generating Tester Prompt and Calling Exploiter...")
    # 3: Prompt generation
    prompt = build_tester_prompt(
        data_flow= flow_json, 
        control_flow=control_result, 
        sarif_summary=sarif_summary, 
        project_root=PROJECT_ROOT,
        sarif_summary_path=SARIF_SUMMARY_PATH
    )

    print("[*] Generated Tester Prompt. Calling Exploiter...")
    # 4: call exploiter
    output = generate(client, model, prompt)

    with open(f"{workspace}tester_raw_output_{time_postfix}.txt", "w", encoding="utf-8") as fh:
        fh.write(output)


    # clean up code-fence wrappers and whitespace
    cleaned = output.strip()

    # remove a leading ``` or ```java
    cleaned = re.sub(r"^```(?:java)?\s*", "", cleaned, flags=re.MULTILINE)

    # remove a trailing ```
    cleaned = re.sub(r"\s*```$", "", cleaned, flags=re.MULTILINE)
    cleaned = cleaned.strip()

    TEST_PATH = f"{workspace}generated_test_{time_postfix}.java"


    with open(TEST_PATH, "w", encoding="utf-8") as f:
        f.write(cleaned)
    
    print(f"[+] Written generated test to: {TEST_PATH}")
    

if __name__ == "__main__":
    
    # arguments
    # --project, --sarif

    argparse_parser = argparse.ArgumentParser(description="E2E Tester Prompt Generator")
    argparse_parser.add_argument("--project", type=str, required=False, default=PROJECT_ROOT, help="Path to the project root")
    argparse_parser.add_argument("--sarif", type=str, required=False, default=SARIF_SUMMARY_PATH, help="Path to the SARIF summary file")
    
    args = argparse_parser.parse_args()

    PROJECT_ROOT = args.project
    SARIF_SUMMARY_PATH = args.sarif

    pipeline()